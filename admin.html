<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Admin Master Inbox</title>
<style>
body{margin:0;font-family:Arial;background:#f4f6fb}
.header{background:#2d1bbf;color:#fff;padding:12px 20px;display:flex;justify-content:space-between;align-items:center}
.container{display:flex;height:calc(100vh - 56px)}
.sidebar{width:320px;background:#fff;border-right:1px solid #ddd;overflow:auto}
.main{flex:1;display:flex;flex-direction:column}
.agent{padding:10px;border-bottom:1px solid #eee;cursor:pointer}
.agent.active{background:#eef}
.chat-header{padding:10px;border-bottom:1px solid #ddd;background:#fff}
.chat-body{flex:1;padding:10px;overflow:auto;background:#fafafa}
.msg{margin-bottom:8px;max-width:70%}
.msg.admin{margin-left:auto;text-align:right}
.msg .bubble{padding:8px 10px;border-radius:10px;display:inline-block}
.msg.customer .bubble{background:#fff;border:1px solid #ddd}
.msg.admin .bubble{background:#2d1bbf;color:#fff}
.chat-input{display:flex;padding:10px;border-top:1px solid #ddd;background:#fff}
.chat-input input{flex:1;padding:8px;border:1px solid #ccc;border-radius:6px}
.chat-input button{margin-left:8px;padding:8px 14px;border:none;background:#2d1bbf;color:#fff;border-radius:6px;cursor:pointer}
</style>
</head>
<body>
<div class="header">
  <b>Admin ‚Äì Master Inbox</b>
  <button onclick="logout()">Logout</button>
</div>
<div class="container">
  <!-- LEFT: ALL CHATS -->
  <div class="sidebar" id="chatList">Loading chats...</div>

  <!-- RIGHT: CHAT WINDOW -->
  <div class="main">
    <div class="chat-header" id="chatHeader">Select a chat</div>
    <div class="chat-body" id="chatBody"></div>
    <div class="chat-input">
      <input id="msgInput" placeholder="Type reply as Admin..." />
      <input type="file" id="fileInput" style="display:none" />
      <button id="attachBtn" title="Attach file/image">üìé</button>
      <button id="recordBtn" title="Record voice">üé§</button>
      <button onclick="sendMsg()">Send</button>
    </div>
  </div>
</div>

<script src="https://dealpad-backend-1.onrender.com/socket.io/socket.io.js"></script>
<script>
// --- File & Voice Controls ---
const fileInput = document.getElementById('fileInput');
const attachBtn = document.getElementById('attachBtn');
const recordBtn = document.getElementById('recordBtn');
let recorder;
let chunks = [];
const adminId = localStorage.getItem("adminId");
if(!adminId) location.href='login.html';

const socket = io("https://dealpad-backend-1.onrender.com", {transports:['websocket']});
let allChats = [];
let activeChat = null;

socket.on('connect',()=>{
  socket.emit('admin_register', adminId);
  // Request initial list of chats for this admin
  socket.emit('admin_get_all_chats');
});

// RECEIVE ALL CHATS (MASTER VIEW)
socket.on('admin_all_chats', chats => {
  allChats = chats;
  renderChatList();
});

function renderChatList(){
  const box = document.getElementById('chatList');
  box.innerHTML='';
  allChats.forEach(c=>{
    const div=document.createElement('div');
    div.className='agent'+(activeChat?.customer===c.customer?' active':'');
    const agentLabel = c.agent || 'None';
    div.innerHTML=`<b>${c.customer}</b><br><small>Agent: ${agentLabel}</small>`;
    div.onclick=()=>openChat(c);
    box.appendChild(div);
  });
}

function openChat(chat){
  activeChat = chat;
  document.getElementById('chatHeader').innerText = `Customer: ${chat.customer} | Agent: ${chat.agent}`;
  // load message history for selected customer phone
  socket.emit('load_messages', chat.customer);
}


// CHAT HISTORY
socket.on('chat_history', msgs => {
  const body = document.getElementById('chatBody');
  body.innerHTML = '';
  msgs.forEach(m => {
    addMsg(m.sender, m.message, {
      fileData: m.fileData,
      fileType: m.fileType,
      fileName: m.fileName,
      voiceNote: m.voiceNote,
      audioData: m.audioData
    });
  });
});

// LIVE MESSAGE
socket.on('new_message', m => {
  if (activeChat && m.customer === activeChat.customer) {
    addMsg(m.sender, m.message, {
      fileData: m.fileData,
      fileType: m.fileType,
      fileName: m.fileName,
      voiceNote: m.voiceNote,
      audioData: m.audioData
    });
  }
});


function addMsg(from, text, opts = {}) {
  const body = document.getElementById('chatBody');
  const div = document.createElement('div');
  div.className = 'msg ' + (from === 'admin' ? 'admin' : 'customer');
  if (opts.fileData && opts.fileType) {
    if (opts.fileType.startsWith('image')) {
      div.innerHTML = `<div class='bubble'><img src='${opts.fileData}' style='max-width:180px;border-radius:6px;'/></div>`;
    } else {
      div.innerHTML = `<div class='bubble'><a href='${opts.fileData}' download='${opts.fileName||'file'}'>üìé ${opts.fileName||'Download File'}</a></div>`;
    }
  } else if (opts.voiceNote && opts.audioData) {
    div.innerHTML = `<div class='bubble'><audio controls src='${opts.audioData}'></audio></div>`;
  } else {
    div.innerHTML = `<div class='bubble'>${text}</div>`;
  }
  body.appendChild(div);
  body.scrollTop = body.scrollHeight;
}


function sendMsg() {
  const input = document.getElementById('msgInput');
  if ((!input.value || input.value.trim() === '') && !sendMsg.pendingFile && !sendMsg.pendingAudio) return;
  if (!activeChat) return;

  // Prepare message data
  const data = {
    to: activeChat.customer,
    message: input.value || ''
  };
  if (sendMsg.pendingFile) {
    Object.assign(data, sendMsg.pendingFile);
    addMsg('admin', '', sendMsg.pendingFile);
    sendMsg.pendingFile = null;
  } else if (sendMsg.pendingAudio) {
    Object.assign(data, sendMsg.pendingAudio);
    addMsg('admin', '', sendMsg.pendingAudio);
    sendMsg.pendingAudio = null;
  } else {
    addMsg('admin', input.value);
  }
  socket.emit('admin_message', data);
  input.value = '';
}

// File/image upload
attachBtn.onclick = () => fileInput.click();
fileInput.onchange = () => {
  const file = fileInput.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    sendMsg.pendingFile = {
      fileData: reader.result,
      fileName: file.name,
      fileType: file.type
    };
    sendMsg();
  };
  reader.readAsDataURL(file);
};

// Voice note
recordBtn.onclick = async () => {
  if (!recorder) {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    recorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
    chunks = [];
    recorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
    recorder.onstop = () => {
      const blob = new Blob(chunks, { type: 'audio/webm' });
      const reader = new FileReader();
      reader.onload = () => {
        sendMsg.pendingAudio = {
          voiceNote: true,
          audioData: reader.result,
          fileType: 'audio/webm'
        };
        sendMsg();
      };
      reader.readAsDataURL(blob);
    };
    recorder.start();
    recordBtn.innerText = '‚èπ Stop';
  } else {
    recorder.stop();
    recorder = null;
    recordBtn.innerText = 'üé§';
  }
};

function logout(){
  socket.disconnect();
  localStorage.removeItem('adminId');
  location.href='login.html';
}
</script>
</body>
</html>