<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Admin Master Inbox</title>
<style>
body{margin:0;font-family:Arial;background:#f4f6fb}
.header{background:#2d1bbf;color:#fff;padding:12px 20px;display:flex;justify-content:space-between;align-items:center}
.container{display:flex;height:calc(100vh - 56px)}
.sidebar{width:320px;background:#fff;border-right:1px solid #ddd;overflow:auto}
.main{flex:1;display:flex;flex-direction:column}
.agent{padding:10px;border-bottom:1px solid #eee;cursor:pointer}
.agent.active{background:#eef}
.chat-header{padding:10px;border-bottom:1px solid #ddd;background:#fff}
.chat-body{flex:1;padding:10px;overflow:auto;background:#fafafa}
.msg{margin-bottom:8px;max-width:70%}
.msg.admin{margin-left:auto;text-align:right}
.msg .bubble{padding:8px 10px;border-radius:10px;display:inline-block}
.msg.customer .bubble{background:#fff;border:1px solid #ddd}
.msg.admin .bubble{background:#2d1bbf;color:#fff}
.chat-input{display:flex;padding:10px;border-top:1px solid #ddd;background:#fff}
.chat-input input{flex:1;padding:8px;border:1px solid #ccc;border-radius:6px}
.chat-input button{margin-left:8px;padding:8px 14px;border:none;background:#2d1bbf;color:#fff;border-radius:6px;cursor:pointer}
</style>
</head>
<body>
<div class="header">
  <b>Admin â€“ Master Inbox</b>
  <button onclick="logout()">Logout</button>
</div>
<div class="container">
  <!-- LEFT: ALL CHATS -->
  <div class="sidebar" id="chatList">Loading chats...</div>

  <!-- RIGHT: CHAT WINDOW -->
  <div class="main">
    <div class="chat-header" id="chatHeader">Select a chat</div>
    <div class="chat-body" id="chatBody"></div>
    <div class="chat-input">
      <input id="msgInput" placeholder="Type reply as Admin..." />
      <button onclick="sendMsg()">Send</button>
    </div>
  </div>
</div>

<script src="https://dealpad-backend-1.onrender.com/socket.io/socket.io.js"></script>
<script>
const adminId = localStorage.getItem("adminId");
if(!adminId) location.href='login.html';

const socket = io("https://dealpad-backend-1.onrender.com", {transports:['websocket']});
let allChats = [];
let activeChat = null;

socket.on('connect',()=>{
  socket.emit('admin_register', adminId);
  // Request initial list of chats for this admin
  socket.emit('admin_get_all_chats');
});

// RECEIVE ALL CHATS (MASTER VIEW)
socket.on('admin_all_chats', chats => {
  allChats = chats;
  renderChatList();
});

function renderChatList(){
  const box = document.getElementById('chatList');
  box.innerHTML='';
  allChats.forEach(c=>{
    const div=document.createElement('div');
    div.className='agent'+(activeChat?.customer===c.customer?' active':'');
    div.innerHTML=`<b>${c.customer}</b><br><small>Agent: ${c.agent||'None'}</small>`;
    div.onclick=()=>openChat(c);
    box.appendChild(div);
  });
}

function openChat(chat){
  activeChat = chat;
  document.getElementById('chatHeader').innerText = `Customer: ${chat.customer} | Agent: ${chat.agent}`;
  socket.emit('admin_join_chat',{customer:chat.customer});
}

// CHAT HISTORY
socket.on('chat_history', msgs => {
  const body=document.getElementById('chatBody');
  body.innerHTML='';
  msgs.forEach(m=>addMsg(m.from,m.text));
});

// LIVE MESSAGE
socket.on('new_message', m => {
  if(activeChat && m.customer===activeChat.customer){
    addMsg(m.from,m.text);
  }
});

function addMsg(from,text){
  const body=document.getElementById('chatBody');
  const div=document.createElement('div');
  div.className='msg '+(from==='admin'?'admin':'customer');
  div.innerHTML=`<div class='bubble'>${text}</div>`;
  body.appendChild(div);
  body.scrollTop=body.scrollHeight;
}

function sendMsg(){
  const input=document.getElementById('msgInput');
  if(!input.value || !activeChat) return;
  socket.emit('admin_send_message',{
    customer:activeChat.customer,
    text:input.value
  });
  addMsg('admin',input.value);
  input.value='';
}

function logout(){
  socket.disconnect();
  localStorage.removeItem('adminId');
  location.href='login.html';
}
</script>
</body>
</html>