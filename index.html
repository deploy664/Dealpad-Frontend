<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Support Dashboard</title>
<link rel="stylesheet" href="style.css" />

<style>
  .container { display:flex; height:100vh; font-family: Arial, sans-serif; }
  .sidebar { width:260px; border-right:1px solid #ddd; padding:12px; overflow:auto; background:#5b2fe6; }
  .sidebar h2 { color:#fff; }
  .sidebar li { background:#fff; padding:12px; border-radius:8px; margin-bottom:10px; cursor:pointer; font-weight:700; }
  .chat-section { flex:1; display:flex; flex-direction:column; }
  .chat-box { flex:1; padding:16px; overflow:auto; background:#fafafa; }
  .agent-msg { align-self:flex-end; background:#cce5ff; padding:8px; border-radius:8px; margin:6px 0; max-width:60%; }
  .customer-msg { align-self:flex-start; background:#fff; padding:8px; border-radius:8px; margin:6px 0; max-width:60%; border:1px solid #eee; }
  .chat-input { display:flex; gap:8px; padding:12px; border-top:1px solid #eee; }
  .chat-input button { width:52px; height:52px; border-radius:50%; border:none; background:#008069; color:#fff; cursor:pointer; }
  .chat-input input { flex:1; padding:12px; border-radius:10px; border:1px solid #ddd; }
  audio { margin-top:6px; display:block; }
</style>
</head>

<body>

<div class="container">

<div class="sidebar">
  <h2>Customers</h2>
  <ul id="customerList"></ul>
</div>

<div class="chat-section">
  <div class="chat-box" id="chatBox"></div>

  <div class="chat-input">
    <button id="recordBtn">üé§</button>
    <input type="text" id="messageInput" placeholder="Type message..." />
    <button id="sendBtn">Send</button>
  </div>
</div>

</div>

<script src="https://dealpad-backend-1.onrender.com/socket.io/socket.io.js"></script>

<script>
const socket = io("https://dealpad-backend-1.onrender.com");

const recordBtn = document.getElementById("recordBtn");
const sendBtn = document.getElementById("sendBtn");
const messageInput = document.getElementById("messageInput");
const chatBox = document.getElementById("chatBox");

let currentCustomer = "923000000000"; // demo
let recorder = null;
let chunks = [];

function uuid(){
  return Math.random().toString(36).slice(2) + Date.now();
}

function renderMessage(msg, sender){
  const div = document.createElement("div");
  div.className = sender === "agent" ? "agent-msg" : "customer-msg";

  if(msg.voiceNote){
    const audio = document.createElement("audio");
    audio.controls = true;
    audio.src = msg.audioSrc;
    div.appendChild(audio);
  } else {
    div.innerText = msg.text;
  }

  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

/* =========================
   SEND TEXT (UNCHANGED)
========================= */
sendBtn.onclick = () => {
  if(!messageInput.value) return;

  socket.emit("agent_message", {
    to: currentCustomer,
    message: messageInput.value
  });

  renderMessage({ text: messageInput.value }, "agent");
  messageInput.value = "";
};

/* =========================
   VOICE SEND ‚Äî FINAL FIX
========================= */
recordBtn.onclick = async () => {

  if (!recorder) {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

    let mime = "";
    if (MediaRecorder.isTypeSupported("audio/ogg; codecs=opus"))
      mime = "audio/ogg; codecs=opus";
    else
      mime = "audio/webm; codecs=opus";

    recorder = new MediaRecorder(stream, { mimeType: mime });
    chunks = [];

    recorder.ondataavailable = e => chunks.push(e.data);

    recorder.onstop = async () => {
      const blob = new Blob(chunks, { type: mime });
      chunks = [];

      const formData = new FormData();
      formData.append("to", currentCustomer);
      formData.append("voice", blob, "voice.ogg");

      await fetch("https://dealpad-backend-1.onrender.com/send-voice", {
        method: "POST",
        body: formData
      });

      socket.emit("agent_message", {
        to: currentCustomer,
        voiceNote: true
      });

      renderMessage({
        voiceNote: true,
        audioSrc: URL.createObjectURL(blob)
      }, "agent");
    };

    recorder.start();
    recordBtn.innerText = "‚èπ";

  } else {
    recorder.stop();
    recorder = null;
    recordBtn.innerText = "üé§";
  }
};
</script>

</body>
</html>
