<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Support Dashboard</title>

<style>
.container{display:flex;height:100vh;font-family:Arial}
.sidebar{width:260px;background:#5b2fe6;padding:12px;color:#fff;overflow:auto}
.sidebar li{background:#fff;color:#000;padding:12px;border-radius:8px;margin-bottom:10px;cursor:pointer;display:flex;align-items:center;font-weight:700}
.sidebar li:hover{background:#f0f0f0}
.badge{background:#e74c3c;color:#fff;border-radius:10px;padding:2px 6px;font-size:12px;margin-left:6px}

.chat-section{flex:1;display:flex;flex-direction:column}
.chat-box{flex:1;padding:16px;overflow:auto;background:#fafafa}

.agent-msg{align-self:flex-end;background:#cce5ff;padding:8px;border-radius:8px;max-width:60%;margin:6px 0}
.customer-msg{align-self:flex-start;background:#fff;padding:8px;border-radius:8px;max-width:60%;margin:6px 0;border:1px solid #eee}

.chat-input{display:flex;gap:8px;padding:10px;border-top:1px solid #eee}
.chat-input button{width:52px;height:52px;border-radius:50%;border:none;background:#008069;color:#fff;cursor:pointer}
.chat-input input{flex:1;padding:10px;border-radius:10px;border:1px solid #ddd}

img{max-width:200px;border-radius:8px;margin-top:6px}
audio{margin-top:6px}
</style>
</head>

<body>

<audio id="notifSound" src="notif.mp3"></audio>

<div class="container">

<div class="sidebar">
<h3>Customers</h3>
<ul id="customerList"></ul>
</div>

<div class="chat-section">
<h3 id="customerName">Select customer</h3>
<div id="chatBox" class="chat-box"></div>

<div class="chat-input">
<button id="attachBtn">üìé</button>
<input type="file" id="fileInput" hidden />
<button id="recordBtn">üé§</button>
<button id="cancelRecordBtn" style="display:none;background:#e74c3c">‚ùå</button>
<input id="messageInput" placeholder="Message..." />
<button id="sendBtn">Send</button>
</div>
</div>

</div>

<script src="https://dealpad-backend-1.onrender.com/socket.io/socket.io.js"></script>
<script>
const socket=io("https://dealpad-backend-1.onrender.com",{transports:["websocket"]})
const agentId=localStorage.getItem("agentId")
if(!agentId) location.href="login.html"

socket.on("connect",()=>socket.emit("register_agent",agentId))

let currentCustomer=null
const chatBox=document.getElementById("chatBox")

function renderMessage(m,sender){
const d=document.createElement("div")
d.className=sender==="agent"?"agent-msg":"customer-msg"

if(m.fileType?.startsWith("image")){let i=document.createElement("img");i.src=m.fileData;d.appendChild(i)}
else if(m.voiceNote){let a=document.createElement("audio");a.controls=true;a.src=m.audioData;d.appendChild(a)}
else if(m.fileData){let l=document.createElement("a");l.href=m.fileData;l.innerText="üìé "+m.fileName;d.appendChild(l)}
else d.innerText=m.message

chatBox.appendChild(d)
chatBox.scrollTop=chatBox.scrollHeight
}

/* ================= SEND TEXT ================= */
sendBtn.onclick=()=>{
if(!currentCustomer||!messageInput.value.trim())return
const msg=messageInput.value.trim()

fetch("/send",{method:"POST",headers:{"Content-Type":"application/json"},
body:JSON.stringify({to:currentCustomer,message:msg})})

renderMessage({message:msg},"agent")
socket.emit("agent_message",{to:currentCustomer,message:msg})
messageInput.value=""
}

/* ================= FILE ================= */
attachBtn.onclick=()=>fileInput.click()
fileInput.onchange=()=>{
const f=fileInput.files[0]
if(!f||!currentCustomer)return
const r=new FileReader()
r.onload=()=>{
fetch("/send",{method:"POST",headers:{"Content-Type":"application/json"},
body:JSON.stringify({to:currentCustomer,fileData:r.result,fileName:f.name,fileType:f.type})})
renderMessage({fileData:r.result,fileName:f.name,fileType:f.type},"agent")
}
r.readAsDataURL(f)
}

/* ================= VOICE (OLD STYLE) ================= */
let recorder,chunks=[],cancelled=false

recordBtn.onclick=async()=>{
cancelled=false
chunks=[]
const stream=await navigator.mediaDevices.getUserMedia({audio:true})
recorder=new MediaRecorder(stream)
recorder.ondataavailable=e=>chunks.push(e.data)
recorder.onstop=()=>{
if(cancelled)return
const blob=new Blob(chunks,{type:"audio/webm"})
const r=new FileReader()
r.onload=()=>{
fetch("/send",{method:"POST",headers:{"Content-Type":"application/json"},
body:JSON.stringify({to:currentCustomer,audioData:r.result,voiceNote:true,fileType:"audio/webm"})})
renderMessage({audioData:r.result,voiceNote:true},"agent")
}
r.readAsDataURL(blob)
}
recorder.start()
recordBtn.style.display="none"
cancelRecordBtn.style.display="inline-block"
}

cancelRecordBtn.onclick=()=>{
cancelled=true
recorder.stop()
recordBtn.style.display="inline-block"
cancelRecordBtn.style.display="none"
}

/* ================= RECEIVE ================= */
socket.on("incoming_message",d=>{
if(d.from!==currentCustomer)return
renderMessage(d,"customer")
})

</script>
</body>
</html>
